{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg border-0" style="border-radius: 1rem;">
                <div class="card-header bg-primary text-white" style="border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                    <h4 class="mb-0">Multi Web Page Parser Code Gen</h4>
                </div>
                <div class="card-body">
                    <form id="web-parse-form" class="mb-4">
                        <div class="mb-3">
                            <label for="url" class="form-label">Target URL</label>
                            <input type="url" class="form-control" id="url" name="url" required>
                        </div>
                         <div class="mb-3">
                            <label for="instructions" class="form-label">Instructions</label>
                            <textarea class="form-control" id="instructions" name="instructions" rows="3" placeholder="Any specific requirements or instructions for data extraction"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="fields" class="form-label">Fields to Extract (comma-separated)</label>
                            <input type="text" class="form-control" id="fields" name="fields" placeholder="e.g. title, price, description">
                        </div>
                        <div class="mb-3">
                            <label for="max_depth" class="form-label">Max Depth</label>
                            <input type="number" class="form-control" id="max_depth" name="max_depth" value="3" min="1" max="10">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="pagination" name="pagination">
                            <label class="form-check-label" for="pagination">Enable Pagination</label>
                        </div>

                        <button type="submit" class="btn btn-primary" id="parse-btn">Start Parsing</button>
                    </form>

                    <div id="status" class="alert alert-info d-none"></div>
                    <div id="error" class="alert alert-danger d-none"></div>

                    <div id="logs-container" class="d-none">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Processing Logs</h5>
                            </div>
                            <div class="card-body">
                                <pre id="logs" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Tree View Visualization -->
                    <div id="tree-view-container" class="d-none mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Crawl Tree Visualization</h5>
                            </div>
                            <div class="card-body">
                                <div id="tree-view"></div>
                            </div>
                        </div>
                    </div>

                    <div id="result-container" class="d-none">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Generated Code</h5>
                            </div>
                            <div class="card-body">
                                <pre id="generated-code" class="bg-light p-3 rounded"></pre>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary" id="copy-code-btn">
                                        <i class="bi bi-clipboard"></i> Copy Code
                                    </button>
                                    <button class="btn btn-outline-success" id="download-code-btn">
                                        <i class="bi bi-download"></i> Download Code
                                    </button>
                                    <button class="btn btn-outline-info" id="save-utility-btn">
                                        <i class="bi bi-save"></i> Save as New Utility
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Extracted Data</h5>
                            </div>
                            <div class="card-body">
                                <div id="data-table-container" class="d-none mb-3">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="data-table">
                                            <thead class="table-dark">
                                                <tr id="table-headers"></tr>
                                            </thead>
                                            <tbody id="table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <pre id="extracted-data" class="bg-light p-3 rounded"></pre>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary" id="copy-data-btn">
                                        <i class="bi bi-clipboard"></i> Copy Data
                                    </button>
                                    <button class="btn btn-outline-success" id="download-data-btn">
                                        <i class="bi bi-download"></i> Download Data
                                    </button>
                                    <button class="btn btn-outline-info" id="download-csv-btn" class="d-none">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Extra Info Card -->
                        <div id="extra-info-container" class="card mb-4 d-none">
                            <div class="card-header">
                                <h5 class="mb-0">Utility Info</h5>
                            </div>
                            <div class="card-body" id="extra-info"></div>
                        </div>
                    </div>

                    <div id="plan-container" class="card mb-4 d-none">
                        <div class="card-header">
                            <h5 class="mb-0">Extraction Plan <a href="#" id="plan-toggle" style="font-size:0.85em; color:#007bff; margin-left:8px;">[Show]</a></h5>
                        </div>
                        <div class="card-body" id="plan-panel" style="display:none;">
                            <button class="btn btn-sm btn-outline-secondary" id="copy-plan-btn" style="float:right; margin-bottom:4px;">Copy</button>
                            <pre id="plan-json" style="background:#f8f9fa; color:#222; border:1px solid #eee; border-radius:4px; max-height:300px; overflow:auto; font-size:0.9em; padding:6px;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Utility Modal -->
<div class="modal fade" id="saveUtilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save as New Utility</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="save-utility-form">
                    <div class="mb-3">
                        <label for="utility-name" class="form-label">Utility Name</label>
                        <input type="text" class="form-control" id="utility-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="utility-description" class="form-label">Description</label>
                        <textarea class="form-control" id="utility-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="utility-prompt" class="form-label">Prompt</label>
                        <textarea class="form-control" id="utility-prompt" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-utility-submit">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('web-parse-form');
    const status = document.getElementById('status');
    const error = document.getElementById('error');
    const logsContainer = document.getElementById('logs-container');
    const logs = document.getElementById('logs');
    const resultContainer = document.getElementById('result-container');
    const generatedCode = document.getElementById('generated-code');
    const extractedData = document.getElementById('extracted-data');
    const dataTableContainer = document.getElementById('data-table-container');
    const dataTable = document.getElementById('data-table');
    const tableHeaders = document.getElementById('table-headers');
    const tableBody = document.getElementById('table-body');
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    const treeViewContainer = document.getElementById('tree-view-container');
    const treeView = document.getElementById('tree-view');
    const planContainer = document.getElementById('plan-container');
    const planPanel = document.getElementById('plan-panel');
    const planJson = document.getElementById('plan-json');
    const planToggle = document.getElementById('plan-toggle');
    const copyPlanBtn = document.getElementById('copy-plan-btn');
    let currentCode = '';
    let currentData = null;
    let currentCsvFile = null;
    let currentPlan = null;

    // Optimized tree update system
    let currentTreeData = null;
    let updateTimeout = null;
    let treeNodeCache = new Map(); // Cache for node elements by URL
    
    // Debounced tree update function
    function updateTreeIncrementally(treeData) {
        currentTreeData = treeData;
        
        // Debug: Log when updates are received
        console.log('🌳 Tree update received:', {
            url: treeData?.url,
            status: treeData?.status,
            progress: treeData?.progress,
            hasPythonCode: !!(treeData?.python_code),
            hasExecutionResult: !!(treeData?.code_execution_result),
            hasAnalysisData: !!(treeData?.analysis_data),
            hasSummary: !!(treeData?.summery),
            timestamp: new Date().toISOString()
        });
        
        // Clear existing timeout
        if (updateTimeout) {
            clearTimeout(updateTimeout);
        }
        
        // Debounce updates to 50ms (reduced from 100ms for more responsive updates)
        updateTimeout = setTimeout(() => {
            console.log('🌳 Processing tree update after debounce');
            performTreeUpdate(treeData);
        }, 50);
    }
    
    // Perform the actual tree update
    function performTreeUpdate(treeData) {
        if (!treeData) return;
        
        try {
            if (!treeView.querySelector('ul')) {
                // Initial render
                treeView.innerHTML = `<ul>${renderTree(treeData)}</ul>`;
                cacheTreeNodes(treeData);
            } else {
                // Incremental update
                updateTreeNodes(treeData);
            }
        } catch (error) {
            console.error('Tree update error:', error);
            // Fallback to full re-render
            treeView.innerHTML = `<ul>${renderTree(treeData)}</ul>`;
            cacheTreeNodes(treeData);
        }
    }
    
    // Cache tree nodes for quick access
    function cacheTreeNodes(node, parentElement = null) {
        if (!node) return;
        
        const nodeElement = parentElement || treeView.querySelector(`[data-url="${node.url}"]`);
        if (nodeElement) {
            treeNodeCache.set(node.url, nodeElement);
            
            // Preserve toggle panel states
            const toggleStates = {};
            const toggles = nodeElement.querySelectorAll('[class*="-toggle"]');
            toggles.forEach(toggle => {
                const panelId = toggle.getAttribute('data-node-id');
                if (panelId) {
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        toggleStates[panelId] = panel.style.display !== 'none';
                    }
                }
            });
            
            // Store toggle states in the cache
            if (Object.keys(toggleStates).length > 0) {
                nodeElement.toggleStates = toggleStates;
            }
        }
        
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => {
                const childElement = nodeElement ? 
                    nodeElement.querySelector(`[data-url="${child.url}"]`) : null;
                cacheTreeNodes(child, childElement);
            });
        }
    }
    
    // Update individual tree nodes
    function updateTreeNodes(node, parentElement = null) {
        if (!node) return;
        
        let nodeElement = treeNodeCache.get(node.url);
        
        if (!nodeElement) {
            // Node doesn't exist, create it
            const newNodeHtml = renderTree(node);
            if (parentElement) {
                const parentUl = parentElement.querySelector('ul') || 
                    parentElement.appendChild(document.createElement('ul'));
                parentUl.insertAdjacentHTML('beforeend', newNodeHtml);
                nodeElement = parentUl.lastElementChild;
            } else {
                // Root node
                treeView.innerHTML = `<ul>${newNodeHtml}</ul>`;
                nodeElement = treeView.querySelector('li');
            }
            treeNodeCache.set(node.url, nodeElement);
        } else {
            // Update existing node - but only update content, not structure
            updateNodeContent(nodeElement, node);
        }
        
        // Update children recursively
        if (node.children && node.children.length > 0) {
            const childrenContainer = nodeElement.querySelector('ul');
            if (!childrenContainer) {
                nodeElement.appendChild(document.createElement('ul'));
            }
            
            node.children.forEach(child => {
                updateTreeNodes(child, nodeElement);
            });
        }
    }
    
    // Update content of a specific node (without affecting structure)
    function updateNodeContent(nodeElement, nodeData) {
        if (!nodeElement || !nodeData) return;

        // Save previous toggle state
        const prevToggles = {
            summery: !!nodeElement.querySelector('.tree-summery-toggle'),
            python_code: !!nodeElement.querySelector('.tree-code-toggle'),
            code_execution_result: !!nodeElement.querySelector('.tree-result-toggle'),
            code_execution_error: !!nodeElement.querySelector('.tree-error-toggle'),
            analysis_data: !!nodeElement.querySelector('.tree-analysis-toggle'),
        };
        const newToggles = {
            summery: !!(nodeData.summery && nodeData.summery.length > 0),
            python_code: !!(nodeData.python_code && nodeData.python_code.length > 0),
            code_execution_result: !!(nodeData.code_execution_result && JSON.stringify(nodeData.code_execution_result).length > 2),
            code_execution_error: !!(nodeData.code_execution_error && nodeData.code_execution_error.length > 0),
            analysis_data: !!(nodeData.analysis_data && Object.keys(nodeData.analysis_data).length > 0),
        };
        // If any new toggle should appear, re-render the node
        let shouldRerender = false;
        for (const key of Object.keys(newToggles)) {
            if (newToggles[key] && !prevToggles[key]) {
                shouldRerender = true;
                break;
            }
        }
        if (shouldRerender) {
            // Re-render the node's HTML
            const parent = nodeElement.parentElement;
            const newNodeHtml = renderTree(nodeData);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newNodeHtml;
            const newNodeElement = tempDiv.firstElementChild;
            parent.replaceChild(newNodeElement, nodeElement);
            treeNodeCache.set(nodeData.url, newNodeElement);
            // Restore toggle states if possible
            restoreToggleStates(newNodeElement);
            return;
        }

        // Update CSS classes for status
        nodeElement.className = `tree-node ${nodeData.status || 'pending'}`;

        // Update status color
        const statusColor = getStatusColor(nodeData.status);
        const titleElement = nodeElement.querySelector('.node-title');
        if (titleElement) {
            titleElement.style.color = statusColor;
        }

        // Update progress
        const progressElement = nodeElement.querySelector('.node-progress');
        if (progressElement && nodeData.progress !== undefined) {
            progressElement.style.width = `${nodeData.progress}%`;
            progressElement.setAttribute('aria-valuenow', nodeData.progress);
        }

        // Update status message
        const statusElement = nodeElement.querySelector('.node-status');
        if (statusElement && nodeData.status_message) {
            statusElement.textContent = nodeData.status_message;
        }

        // Update relevance score
        const scoreElement = nodeElement.querySelector('.node-score');
        if (scoreElement && nodeData.relevance_score !== undefined) {
            scoreElement.textContent = `(score: ${nodeData.relevance_score.toFixed(2)})`;
        }

        // Update page type
        const typeElement = nodeElement.querySelector('.node-type');
        if (typeElement && nodeData.page_type) {
            typeElement.textContent = `[${nodeData.page_type}]`;
        }

        // Update exclusive fields
        const exclusiveFieldsElement = nodeElement.querySelector('.exclusive-fields');
        if (exclusiveFieldsElement && nodeData.exclusive_fields) {
            const spanElement = exclusiveFieldsElement.querySelector('span');
            if (spanElement) {
                spanElement.textContent = nodeData.exclusive_fields.join(', ');
            }
        }

        // Add loading animation for processing nodes
        if (nodeData.status === 'processing') {
            const titleElement = nodeElement.querySelector('.node-title');
            if (titleElement && !titleElement.querySelector('.loading-dots')) {
                titleElement.innerHTML += '<span class="loading-dots"></span>';
            }
        } else {
            const loadingDots = nodeElement.querySelector('.loading-dots');
            if (loadingDots) {
                loadingDots.remove();
            }
        }

        // Update toggle panels if they exist
        updateTogglePanels(nodeElement, nodeData);

        // Restore toggle states after update
        restoreToggleStates(nodeElement);
    }
    
    // Update toggle panels for a node
    function updateTogglePanels(nodeElement, nodeData) {
        if (!nodeElement || !nodeData) return;
        
        // Update summary panel
        if (nodeData.summery) {
            const summeryPanel = nodeElement.querySelector('.tree-summery-panel');
            if (summeryPanel) {
                const contentDiv = summeryPanel.querySelector('div:last-child');
                if (contentDiv) {
                    contentDiv.textContent = nodeData.summery;
                }
            }
        }
        
        // Update Python code panel
        if (nodeData.python_code) {
            const codePanel = nodeElement.querySelector('.tree-code-panel');
            if (codePanel) {
                const preElement = codePanel.querySelector('pre');
                if (preElement) {
                    preElement.textContent = nodeData.python_code;
                }
            }
        }
        
        // Update execution result panel
        if (nodeData.code_execution_result) {
            const resultPanel = nodeElement.querySelector('.tree-result-panel');
            if (resultPanel) {
                const preElement = resultPanel.querySelector('pre');
                if (preElement) {
                    preElement.textContent = JSON.stringify(nodeData.code_execution_result, null, 2);
                }
            }
        }
        
        // Update analysis data panel
        if (nodeData.analysis_data) {
            const analysisPanel = nodeElement.querySelector('.tree-analysis-panel');
            if (analysisPanel) {
                const preElement = analysisPanel.querySelector('pre');
                if (preElement) {
                    preElement.textContent = JSON.stringify(nodeData.analysis_data, null, 2);
                }
            }
        }
    }

    // Get status color
    function getStatusColor(status) {
        switch (status) {
            case 'completed':
            case 'done':
                return '#28a745';
            case 'processing':
                return '#007bff';
            case 'error':
                return '#dc3545';
            case 'pending':
            default:
                return '#ffc107';
        }
    }

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Reset UI
        status.classList.remove('d-none');
        error.classList.add('d-none');
        resultContainer.classList.add('d-none');
        logsContainer.classList.remove('d-none');
        logs.textContent = '';
        dataTableContainer.classList.add('d-none');
        downloadCsvBtn.classList.add('d-none');
        treeViewContainer.classList.add('d-none');
        treeView.innerHTML = '';
        planContainer.classList.add('d-none');
        planPanel.style.display = 'none';
        planJson.textContent = '';
        planToggle.textContent = '[Show]';
        status.textContent = 'Starting web parsing...';
        
        // Get form data
        const formData = {
            url: document.getElementById('url').value,
            fields: document.getElementById('fields').value.split(',').map(f => f.trim()).filter(f => f),
            max_depth: parseInt(document.getElementById('max_depth').value),
            pagination: document.getElementById('pagination').checked,
            instructions: document.getElementById('instructions').value
        };

        try {
            // Create EventSource for streaming
            const eventSource = new EventSource(`/web_parse_utility?${new URLSearchParams({
                url: formData.url,
                fields: formData.fields.join(','),
                max_depth: formData.max_depth,
                pagination: formData.pagination,
                instructions: formData.instructions
            })}`);

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log("eventSource:onmessage: ", data)
                    
                    switch(data.type) {
                        case 'status':
                            status.textContent = data.message;
                            break;
                        case 'log':
                            logs.textContent += data.message + '\n';
                            logs.scrollTop = logs.scrollHeight;
                            break;
                        case 'plan':
                            if (data.plan) {
                                planContainer.classList.remove('d-none');
                                planJson.textContent = JSON.stringify(data.plan, null, 2);
                                currentPlan = data.plan;
                                planPanel.style.display = 'none';
                                planToggle.textContent = '[Hide]';
                            }
                            break;
                        case 'complete':
                            currentCode = data.code;
                            currentData = data.extracted_data || data.result;
                            currentCsvFile = data.csv_file;
                            
                            // Display the generated code
                            generatedCode.textContent = data.code;
                            
                            // Display extracted data
                            if (data.extracted_data && data.extracted_data.length > 0) {
                                // Populate data table
                                populateDataTable(data.extracted_data);
                                dataTableContainer.classList.remove('d-none');
                                
                                // Show CSV download button if CSV file exists
                                if (data.csv_file) {
                                    downloadCsvBtn.classList.remove('d-none');
                                }
                            } else if (data.message) {
                                extractedData.textContent = data.message;
                                dataTableContainer.classList.add('d-none');
                                downloadCsvBtn.classList.add('d-none');
                            } else {
                                extractedData.textContent = JSON.stringify(data.result, null, 2);
                                dataTableContainer.classList.add('d-none');
                                downloadCsvBtn.classList.add('d-none');
                            }
                            
                            // Show extra info if present
                            if (data.extra_info && Object.keys(data.extra_info).length > 0) {
                                let infoHtml = '';
                                for (const [key, value] of Object.entries(data.extra_info)) {
                                    infoHtml += `<div><strong>${key}:</strong> <pre>${typeof value === 'object' ? JSON.stringify(value, null, 2) : value}</pre></div>`;
                                }
                                document.getElementById('extra-info').innerHTML = infoHtml;
                                document.getElementById('extra-info-container').classList.remove('d-none');
                            } else {
                                document.getElementById('extra-info-container').classList.add('d-none');
                            }
                            
                            // Show success/error message
                            if (data.execution_success) {
                                if (data.total_items > 0) {
                                    status.textContent = `✅ Successfully extracted ${data.total_items} items`;
                                    status.className = 'alert alert-success';
                                } else {
                                    status.textContent = data.message || '✅ Execution completed but no data was extracted';
                                    status.className = 'alert alert-warning';
                                }
                            } else {
                                status.textContent = `❌ Execution failed: ${data.error || 'Unknown error'}`;
                                status.className = 'alert alert-danger';
                            }
                            
                            resultContainer.classList.remove('d-none');
                            status.classList.remove('d-none');
                            eventSource.close();
                            break;
                        case 'error':
                            error.textContent = data.error;
                            error.classList.remove('d-none');
                            status.classList.add('d-none');
                            eventSource.close();
                            break;
                        case 'tree_update':
                            if (data.tree) {
                                treeViewContainer.classList.remove('d-none');
                                updateTreeIncrementally(data.tree);
                            }
                            break;
                    }
                } catch (err) {
                    console.error('Error parsing event data:', err);
                    error.textContent = 'Error processing server response';
                    error.classList.remove('d-none');
                    status.classList.add('d-none');
                    eventSource.close();
                }
            };

            eventSource.onerror = function(err) {
                console.error('EventSource error:', err);
                error.textContent = 'Connection error occurred';
                error.classList.remove('d-none');
                status.classList.add('d-none');
                eventSource.close();
            };

        } catch (err) {
            console.error('Error:', err);
            error.textContent = err.message;
            error.classList.remove('d-none');
            status.classList.add('d-none');
        }
    });

    // Function to populate the data table
    function populateDataTable(data) {
        if (!data || data.length === 0) return;
        
        // Clear existing table
        tableHeaders.innerHTML = '';
        tableBody.innerHTML = '';
        
        // Get all unique keys from the data
        const allKeys = new Set();
        data.forEach(item => {
            Object.keys(item).forEach(key => allKeys.add(key));
        });
        const keys = Array.from(allKeys);
        
        // Create headers
        keys.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            tableHeaders.appendChild(th);
        });
        
        // Create rows
        data.forEach(item => {
            const row = document.createElement('tr');
            keys.forEach(key => {
                const td = document.createElement('td');
                td.textContent = item[key] || '';
                row.appendChild(td);
            });
            tableBody.appendChild(row);
        });
    }

    // Download CSV button
    downloadCsvBtn.addEventListener('click', function() {
        // Use the web parse CSV download endpoint
        window.open('/download_web_parse_csv', '_blank');
    });

    // Copy code button
    document.getElementById('copy-code-btn').addEventListener('click', function() {
        navigator.clipboard.writeText(currentCode).then(() => {
            this.textContent = 'Copied!';
            setTimeout(() => this.textContent = 'Copy Code', 2000);
        });
    });

    // Download code button
    document.getElementById('download-code-btn').addEventListener('click', function() {
        const blob = new Blob([currentCode], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'web_parser.py';
        a.click();
        window.URL.revokeObjectURL(url);
    });

    // Copy data button
    document.getElementById('copy-data-btn').addEventListener('click', function() {
        navigator.clipboard.writeText(JSON.stringify(currentData, null, 2)).then(() => {
            this.textContent = 'Copied!';
            setTimeout(() => this.textContent = 'Copy Data', 2000);
        });
    });

    // Download data button
    document.getElementById('download-data-btn').addEventListener('click', function() {
        const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'extracted_data.json';
        a.click();
        window.URL.revokeObjectURL(url);
    });

    // Save utility button
    document.getElementById('save-utility-btn').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('saveUtilityModal'));
        modal.show();
    });

    // Save utility submit
    document.getElementById('save-utility-submit').addEventListener('click', async function() {
        const name = document.getElementById('utility-name').value;
        const description = document.getElementById('utility-description').value;
        const prompt = document.getElementById('utility-prompt').value;

        try {
            const response = await fetch('/save_web_parse_utility', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: currentCode,
                    name: name,
                    description: description,
                    prompt: prompt
                })
            });

            const result = await response.json();
            if (result.success) {
                alert('Utility saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('saveUtilityModal')).hide();
            } else {
                alert('Error saving utility: ' + result.error);
            }
        } catch (err) {
            alert('Error saving utility: ' + err.message);
        }
    });

    // Helper to render the tree recursively
    function renderTree(node, depth = 0, nodeIdPrefix = 'tree-node-') {
        if (!node) return '';
        
        // Generate stable ID based on URL
        const nodeId = node.url ? node.url.replace(/[^a-zA-Z0-9]/g, '_') : `node_${Math.random().toString(36).substr(2, 6)}`;
        const stablePrefix = `tree-${nodeId}`;
        
        let childrenHtml = '';
        if (node.children && node.children.length > 0) {
            childrenHtml = `<ul style='margin-left: 1em;'>${node.children.map((child, idx) => renderTree(child, depth + 1, stablePrefix + '-')).join('')}</ul>`;
        }
        
        const statusColor = getStatusColor(node.status);
        const progressBar = node.progress !== undefined ? 
            `<div class="progress" style="height: 4px; margin-top: 2px;">
                <div class="node-progress progress-bar" role="progressbar" style="width: ${node.progress}%; background-color: ${statusColor};" 
                     aria-valuenow="${node.progress}" aria-valuemin="0" aria-valuemax="100"></div>
             </div>` : '';
        
        let exclusiveFieldsHtml = '';
        if (node.exclusive_fields && node.exclusive_fields.length > 0) {
            exclusiveFieldsHtml = `<div class="exclusive-fields" style='font-size:0.85em; color:#888; margin-top:2px;'>Exclusive fields: <span style='color:#555;'>${node.exclusive_fields.join(', ')}</span></div>`;
        }
        
        let urlHtml = '';
        if (node.url) {
            urlHtml = `<div style='font-size:0.85em; color:#888;'><a href='${node.url}' target='_blank' style='color:#888; text-decoration:underline;'>${node.url}</a></div>`;
        }
        
        // Status message
        const statusMessage = node.status_message ? 
            `<div class="node-status" style='font-size:0.85em; color:#666; margin-top:2px;'>${escapeHtml(node.status_message)}</div>` : '';
        
        // Summery toggle with stable ID
        let summeryToggleHtml = '';
        let summeryPanelHtml = '';
        const summeryId = stablePrefix + '-summery';
        if (node.summery && node.summery.length > 0) {
            summeryToggleHtml = `<a href='#' class='tree-summery-toggle' data-node-id='${summeryId}' style='font-size:0.85em; color:#007bff; margin-left:8px;'>[Show Summary]</a>`;
            summeryPanelHtml = `<div id='${summeryId}' class='tree-summery-panel' style='display:none; margin-top:4px; margin-bottom:4px;'>
                <div style='font-size:0.85em; color:#444; margin-bottom:2px;'><b>Summary:</b></div>
                <div style='background:#f8f9fa; color:#222; border:1px solid #eee; border-radius:4px; max-height:120px; overflow:auto; font-size:0.9em; padding:6px;'>${escapeHtml(node.summery)}</div>
            </div>`;
        }
        
        // Code toggle with stable ID
        let codeToggleHtml = '';
        let codePanelHtml = '';
        const codeId = stablePrefix + '-code';
        if (node.python_code && node.python_code.length > 0) {
            codeToggleHtml = `<a href='#' class='tree-code-toggle' data-node-id='${codeId}' style='font-size:0.85em; color:#007bff; margin-left:8px;'>[Show Python Code]</a>`;
            codePanelHtml = `<div id='${codeId}' class='tree-code-panel' style='display:none; margin-top:4px; margin-bottom:4px;'>
                <button class='btn btn-sm btn-outline-secondary tree-copy-btn' data-copy-target='${codeId}-pre' style='float:right; margin-bottom:4px;'>Copy</button>
                <div style='font-size:0.85em; color:#444; margin-bottom:2px;'><b>Python Code:</b></div>
                <pre id='${codeId}-pre' style='background:#f8f9fa; color:#222; border:1px solid #eee; border-radius:4px; max-height:200px; overflow:auto; font-size:0.9em; padding:6px;'>${escapeHtml(node.python_code)}</pre>
            </div>`;
        }
        
        // Result toggle with stable ID
        let resultToggleHtml = '';
        let resultPanelHtml = '';
        const resultId = stablePrefix + '-result';
        if (node.code_execution_result && JSON.stringify(node.code_execution_result).length > 2) {
            resultToggleHtml = `<a href='#' class='tree-result-toggle' data-node-id='${resultId}' style='font-size:0.85em; color:#007bff; margin-left:8px;'>[Show Output]</a>`;
            resultPanelHtml = `<div id='${resultId}' class='tree-result-panel' style='display:none; margin-top:4px; margin-bottom:4px;'>
                <button class='btn btn-sm btn-outline-secondary tree-copy-btn' data-copy-target='${resultId}-pre' style='float:right; margin-bottom:4px;'>Copy</button>
                <div style='font-size:0.85em; color:#444; margin-bottom:2px;'><b>Execution Result:</b></div>
                <pre id='${resultId}-pre' style='background:#f8f9fa; color:#222; border:1px solid #eee; border-radius:4px; max-height:200px; overflow:auto; font-size:0.9em; padding:6px;'>${escapeHtml(JSON.stringify(node.code_execution_result, null, 2))}</pre>
            </div>`;
        }
        
        // Error toggle with stable ID
        let errorToggleHtml = '';
        let errorPanelHtml = '';
        const errorId = stablePrefix + '-error';
        if (node.code_execution_error && node.code_execution_error.length > 0) {
            errorToggleHtml = `<a href='#' class='tree-error-toggle' data-node-id='${errorId}' style='font-size:0.85em; color:#dc3545; margin-left:8px;'>[Show Error]</a>`;
            errorPanelHtml = `<div id='${errorId}' class='tree-error-panel' style='display:none; margin-top:4px; margin-bottom:4px;'>
                <div style='font-size:0.85em; color:#444; margin-bottom:2px;'><b>Execution Error:</b></div>
                <pre style='background:#f8f9fa; color:#dc3545; border:1px solid #eee; border-radius:4px; max-height:120px; overflow:auto; font-size:0.9em; padding:6px;'>${escapeHtml(node.code_execution_error)}</pre>
            </div>`;
        }
        
        // Analysis toggle with stable ID
        let analysisToggleHtml = '';
        let analysisPanelHtml = '';
        const analysisId = stablePrefix + '-analysis';
        if (node.analysis_data && Object.keys(node.analysis_data).length > 0) {
            analysisToggleHtml = `<a href='#' class='tree-analysis-toggle' data-node-id='${analysisId}' style='font-size:0.85em; color:#007bff; margin-left:8px;'>[Show Analysis JSON]</a>`;
            analysisPanelHtml = `<div id='${analysisId}' class='tree-analysis-panel' style='display:none; margin-top:4px; margin-bottom:4px;'>
                <button class='btn btn-sm btn-outline-secondary tree-copy-btn' data-copy-target='${analysisId}-pre' style='float:right; margin-bottom:4px;'>Copy</button>
                <div style='font-size:0.85em; color:#444; margin-bottom:2px;'><b>Analysis Data (JSON):</b></div>
                <pre id='${analysisId}-pre' style='background:#f8f9fa; color:#222; border:1px solid #eee; border-radius:4px; max-height:300px; overflow:auto; font-size:0.9em; padding:6px;'>${escapeHtml(JSON.stringify(node.analysis_data, null, 2))}</pre>
            </div>`;
        }
        
        return `<li data-url="${node.url || ''}" data-node-id="${nodeId}" class="tree-node ${node.status || 'pending'}" style='margin-bottom: 0.5em;'>
            <span class="node-title" style='font-weight:bold; color:${statusColor}'>${node.label || node.url}</span>
            <span class="node-type" style='color: #888; font-size: 0.9em;'> [${node.page_type || ''}]</span>
            <span class="node-score" style='color: #aaa; font-size: 0.8em;'> (score: ${node.relevance_score?.toFixed(2) || '0.00'})</span>
            ${exclusiveFieldsHtml}
            ${urlHtml}
            ${statusMessage}
            ${progressBar}
            ${summeryToggleHtml}
            ${summeryPanelHtml}
            ${codeToggleHtml}
            ${codePanelHtml}
            ${resultToggleHtml}
            ${resultPanelHtml}
            ${errorToggleHtml}
            ${errorPanelHtml}
            ${analysisToggleHtml}
            ${analysisPanelHtml}
            ${childrenHtml}
        </li>`;
    }

    // Helper to escape HTML for code blocks
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/\"/g, '&quot;')
                   .replace(/'/g, '&#39;');
    }

    // Toggle code, result, summery, and analysis panels on click
    document.addEventListener('click', function(e) {
        // Python code toggle
        if (e.target && e.target.classList.contains('tree-code-toggle')) {
            e.preventDefault();
            const nodeId = e.target.getAttribute('data-node-id');
            const panel = document.getElementById(nodeId);
            if (panel) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    e.target.textContent = '[Hide Python Code]';
                } else {
                    panel.style.display = 'none';
                    e.target.textContent = '[Show Python Code]';
                }
            }
        }
        // Execution result toggle
        if (e.target && e.target.classList.contains('tree-result-toggle')) {
            e.preventDefault();
            const nodeId = e.target.getAttribute('data-node-id');
            const panel = document.getElementById(nodeId);
            if (panel) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    e.target.textContent = '[Hide Output]';
                } else {
                    panel.style.display = 'none';
                    e.target.textContent = '[Show Output]';
                }
            }
        }
        // Summery toggle
        if (e.target && e.target.classList.contains('tree-summery-toggle')) {
            e.preventDefault();
            const nodeId = e.target.getAttribute('data-node-id');
            const panel = document.getElementById(nodeId);
            if (panel) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    e.target.textContent = '[Hide Summary]';
                } else {
                    panel.style.display = 'none';
                    e.target.textContent = '[Show Summary]';
                }
            }
        }
        // Analysis data toggle
        if (e.target && e.target.classList.contains('tree-analysis-toggle')) {
            e.preventDefault();
            const nodeId = e.target.getAttribute('data-node-id');
            const panel = document.getElementById(nodeId);
            if (panel) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    e.target.textContent = '[Hide Analysis JSON]';
                } else {
                    panel.style.display = 'none';
                    e.target.textContent = '[Show Analysis JSON]';
                }
            }
        }
        // Copy button
        if (e.target && e.target.classList.contains('tree-copy-btn')) {
            e.preventDefault();
            const preId = e.target.getAttribute('data-copy-target');
            const pre = document.getElementById(preId);
            if (pre) {
                const text = pre.innerText;
                navigator.clipboard.writeText(text).then(() => {
                    e.target.textContent = 'Copied!';
                    setTimeout(() => e.target.textContent = 'Copy', 1500);
                });
            }
        }
    });

    // Plan toggle
    planToggle.addEventListener('click', function(e) {
        e.preventDefault();
        if (planPanel.style.display === 'none') {
            planPanel.style.display = 'block';
            planToggle.textContent = '[Hide]';
        } else {
            planPanel.style.display = 'none';
            planToggle.textContent = '[Show]';
        }
    });

    // Copy plan button
    copyPlanBtn.addEventListener('click', function() {
        if (currentPlan) {
            navigator.clipboard.writeText(JSON.stringify(currentPlan, null, 2)).then(() => {
                copyPlanBtn.textContent = 'Copied!';
                setTimeout(() => copyPlanBtn.textContent = 'Copy', 1500);
            });
        }
    });

    // Restore toggle states for a node
    function restoreToggleStates(nodeElement) {
        if (!nodeElement || !nodeElement.toggleStates) return;
        
        Object.entries(nodeElement.toggleStates).forEach(([panelId, isVisible]) => {
            const panel = document.getElementById(panelId);
            const toggle = nodeElement.querySelector(`[data-node-id="${panelId}"]`);
            
            if (panel && toggle) {
                if (isVisible) {
                    panel.style.display = 'block';
                    // Update toggle text
                    if (toggle.classList.contains('tree-summery-toggle')) {
                        toggle.textContent = '[Hide Summary]';
                    } else if (toggle.classList.contains('tree-code-toggle')) {
                        toggle.textContent = '[Hide Python Code]';
                    } else if (toggle.classList.contains('tree-result-toggle')) {
                        toggle.textContent = '[Hide Output]';
                    } else if (toggle.classList.contains('tree-error-toggle')) {
                        toggle.textContent = '[Hide Error]';
                    } else if (toggle.classList.contains('tree-analysis-toggle')) {
                        toggle.textContent = '[Hide Analysis JSON]';
                    }
                } else {
                    panel.style.display = 'none';
                    // Update toggle text
                    if (toggle.classList.contains('tree-summery-toggle')) {
                        toggle.textContent = '[Show Summary]';
                    } else if (toggle.classList.contains('tree-code-toggle')) {
                        toggle.textContent = '[Show Python Code]';
                    } else if (toggle.classList.contains('tree-result-toggle')) {
                        toggle.textContent = '[Show Output]';
                    } else if (toggle.classList.contains('tree-error-toggle')) {
                        toggle.textContent = '[Show Error]';
                    } else if (toggle.classList.contains('tree-analysis-toggle')) {
                        toggle.textContent = '[Show Analysis JSON]';
                    }
                }
            }
        });
    }
});
</script>

<style>
    /* Tree view optimizations */
    .tree-view {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background: #fafafa;
    }
    
    .tree-view ul {
        list-style: none;
        padding-left: 20px;
    }
    
    .tree-view li {
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 4px;
        background: white;
        border: 1px solid #e0e0e0;
        transition: all 0.2s ease;
    }
    
    .tree-view li:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tree-view li.processing {
        border-left: 4px solid #007bff;
        background: #f8f9ff;
    }
    
    .tree-view li.completed {
        border-left: 4px solid #28a745;
        background: #f8fff8;
    }
    
    .tree-view li.error {
        border-left: 4px solid #dc3545;
        background: #fff8f8;
    }
    
    .tree-view li.pending {
        border-left: 4px solid #ffc107;
        background: #fffef8;
    }
    
    /* Progress bar styling */
    .progress {
        height: 4px;
        margin-top: 4px;
        background-color: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .progress-bar {
        transition: width 0.3s ease;
    }
    
    /* Node content styling */
    .node-title {
        font-weight: bold;
        display: block;
        margin-bottom: 2px;
    }
    
    .node-type {
        color: #888;
        font-size: 0.9em;
    }
    
    .node-score {
        color: #aaa;
        font-size: 0.8em;
    }
    
    .node-status {
        font-size: 0.85em;
        color: #666;
        margin-top: 2px;
        font-style: italic;
    }
    
    /* Toggle buttons */
    .tree-toggle {
        font-size: 0.85em;
        color: #007bff;
        text-decoration: none;
        margin-left: 8px;
        cursor: pointer;
    }
    
    .tree-toggle:hover {
        text-decoration: underline;
    }
    
    /* Code panels */
    .tree-panel {
        display: none;
        margin-top: 4px;
        margin-bottom: 4px;
        padding: 8px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
    }
    
    .tree-panel pre {
        background: #f8f9fa;
        color: #222;
        border: 1px solid #eee;
        border-radius: 4px;
        max-height: 200px;
        overflow: auto;
        font-size: 0.9em;
        padding: 6px;
        margin: 0;
    }
    
    /* Copy button */
    .tree-copy-btn {
        float: right;
        margin-bottom: 4px;
        font-size: 0.8em;
    }
    
    /* Loading animation */
    .loading-dots {
        display: inline-block;
        animation: loading-dots 1.5s infinite;
    }
    
    @keyframes loading-dots {
        0%, 20% { content: ""; }
        40% { content: "."; }
        60% { content: ".."; }
        80%, 100% { content: "..."; }
    }
    
    /* Optimize for performance */
    .tree-view * {
        will-change: auto;
    }
    
    .tree-view li {
        contain: layout style;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .tree-view {
            max-height: 400px;
        }
        
        .tree-view ul {
            padding-left: 10px;
        }
        
        .tree-view li {
            padding: 6px;
            margin-bottom: 6px;
        }
    }
</style>
{% endblock %} 