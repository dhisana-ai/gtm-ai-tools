{% extends 'base.html' %}

{% block content %}
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info" role="alert">
        {% for m in messages %}
          <div>{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2>Run a Utility</h2>
  <form method="post" enctype="multipart/form-data" class="mb-4" id="util-form">
    <input type="hidden" name="mode" value="util">
    <div class="mb-3">
      <label class="form-label">Utility</label>
      <select class="form-select" name="util_name" id="util-select">
        {% for name, desc in utils %}
          <option value="{{ name }}" {% if name == default_util %}selected{% endif %}>{{ loop.index }}. {{ desc }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Input Mode</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="input_mode" id="mode-single" value="single" checked>
        <label class="form-check-label" for="mode-single">Single Input</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="input_mode" id="mode-upload" value="file">
        <label class="form-check-label" for="mode-upload">Upload input list</label>
      </div>
    </div>
    <div id="params-container"></div>
    <div class="mb-3" id="file-container" style="display:none;">
      <input class="form-control" type="file" name="csv_file">
    </div>
    <button class="btn btn-success" type="submit" name="action" value="run_util">Run</button>
  </form>

  <script>
    const PARAM_MAP = {{ util_params|tojson }};
    function renderParams() {
      const select = document.getElementById('util-select');
      const container = document.getElementById('params-container');
      container.innerHTML = '';
      const util = select.value;
      const params = PARAM_MAP[util] || [];
      params.forEach(p => {
        const div = document.createElement('div');
        const input = document.createElement('input');
        const label = document.createElement('label');
        label.textContent = p.label;
        input.name = p.name;
        if (p.type === 'boolean') {
          div.className = 'form-check mb-3';
          input.type = 'checkbox';
          input.className = 'form-check-input';
          input.value = '1';
          input.id = p.name;
          label.className = 'form-check-label';
          label.setAttribute('for', p.name);
          div.appendChild(input);
          div.appendChild(label);
        } else {
          div.className = 'mb-3';
          input.type = 'text';
          input.className = 'form-control';
          label.className = 'form-label';
          div.appendChild(label);
          div.appendChild(input);
        }
        container.appendChild(div);
      });
    }

    function updateMode() {
      const mode = document.querySelector('input[name="input_mode"]:checked').value;
      document.getElementById('file-container').style.display = mode === 'file' ? '' : 'none';
      document.getElementById('params-container').style.display = mode === 'file' ? 'none' : '';
    }
    document.getElementById('util-select').addEventListener('change', renderParams);
    document.querySelectorAll('input[name="input_mode"]').forEach(el => el.addEventListener('change', updateMode));
    document.addEventListener('DOMContentLoaded', () => { renderParams(); updateMode(); });
  </script>

  {% if util_output %}
    <h3>Output</h3>
    <textarea class="form-control" rows="10" readonly>{{ util_output }}</textarea>
  {% endif %}
  {% if download_name %}
    <a class="btn btn-primary" href="{{ url_for('download_file', filename=download_name) }}">Download CSV</a>
  {% endif %}

{% endblock %}
