{% extends 'base.html' %}

{% block content %}
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info" role="alert">
        {% for m in messages %}
          <div>{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2>Run a Utility</h2>
  <p class="lead">
    Vibe code and add your own GTM workflow in 5 min!
    <a href="https://github.com/dhisana-ai/gtm-ai-tools/blob/main/docs/vibe_coding_workflows.md" target="_blank">Vibe coding instructions</a>
  </p>
  <div class="row">
    <div class="col-md-4 mb-4" style="max-height: 80vh; overflow-y: auto; overflow-x: hidden;">
      {% for util in utils %}
        <div class="card util-card mb-3" data-util="{{ util.name }}" role="button" style="cursor:pointer;">
          <div class="card-body">
            <h5 class="card-title mb-1">{{ util.title }}</h5>
            <p class="card-text small text-muted">{{ util.desc }}</p>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="col-md-8">
      <form method="post" enctype="multipart/form-data" class="mb-4" id="util-form">
        <input type="hidden" name="mode" value="util">
        <input type="hidden" name="util_name" id="util-name-input" value="{{ default_util }}">
        <div class="mb-3">
          <h4 id="util-title"></h4>
          <p id="util-desc" class="text-muted"></p>
        </div>
        <div class="mb-3" id="input-mode-group">
          <label class="form-label">Input Mode</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="input_mode" id="mode-single" value="single" checked>
            <label class="form-check-label" for="mode-single">Single Input</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="input_mode" id="mode-upload" value="file">
            <label class="form-check-label" for="mode-upload">Upload input list</label>
          </div>
        </div>
        <div id="params-container"></div>
        <div class="mb-3" id="file-container" style="display:none;">
          <input class="form-control" type="file" name="csv_file">
        </div>
        <button id="run-button" class="btn btn-success" type="submit" name="action" value="run_util">Run</button>
        <div id="run-spinner" class="spinner-border text-success ms-2" role="status" style="display:none;width:1rem;height:1rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
      </form>

      <div id="output-section">
        {% if download_name %}
          {% set is_image = download_name.endswith('.png') %}
          <a class="btn btn-primary" href="{{ url_for('download_file', filename=download_name) }}">
            {{ 'Download Image' if is_image else 'Download CSV' }}
          </a>
        {% endif %}
        {% if image_src %}
          <div class="mt-3">
            <img src="{{ image_src }}" class="img-fluid" alt="Generated Image">
          </div>
        {% endif %}
        {% if csv_rows %}
          <h3 class="mt-4">Input or Output Preview</h3>
          <div id="csv-grid" class="ag-theme-alpine" style="height:400px;width:100%;"></div>
          <script>
            const csvData = {{ csv_rows|tojson }};
            const columnDefs = csvData.length
              ? Object.keys(csvData[0]).map(k => {
                  if (k === 'user_linkedin_url') {
                    return {
                      field: k,
                      cellRenderer: params => {
                        if (!params.value) return '';
                        const url = params.value.startsWith('http')
                          ? params.value
                          : `https://${params.value}`;
                        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${params.value}</a>`;
                      }
                    };
                  }
                  return { field: k };
                })
              : [];
            const gridOptions = {
              columnDefs,
              rowData: csvData,
              pagination: true,
              paginationPageSize: 20,
              enableRangeSelection: true
            };
            document.addEventListener('DOMContentLoaded', () => {
              const gridDiv = document.getElementById('csv-grid');
              agGrid.createGrid(gridDiv, gridOptions);
            });
          </script>
        {% endif %}
        {% if util_output %}
          <h3>Output</h3>
          <textarea class="form-control" rows="10" readonly>{{ util_output }}</textarea>
        {% endif %}
        {% if (download_name or util_output) and default_util != 'generate_image' %}
          <form method="post" action="{{ url_for('push_to_dhisana') }}" class="mt-2">
            <input type="hidden" name="csv_path" value="{{ download_name }}">
            <input type="hidden" name="output_text" value="{{ util_output }}">
            <button class="btn btn-warning" type="submit">Push to Dhisana AI Contacts</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    const PARAM_MAP = {{ util_params|tojson }};
    const UPLOAD_ONLY_UTILS = {{ upload_only|tojson }};
    const utilInput = document.getElementById('util-name-input');

      function selectUtil(name) {
        utilInput.value = name;
        document.querySelectorAll('.util-card').forEach(card => {
          card.classList.toggle('border-primary', card.dataset.util === name);
        });
        const card = document.querySelector(`.util-card[data-util="${name}"]`);
        if (card) {
          const title = card.querySelector('.card-title')?.textContent || '';
          const desc = card.querySelector('.card-text')?.textContent || '';
          document.getElementById('util-title').textContent = title;
          document.getElementById('util-desc').textContent = desc;
        }
        updateMode();
      }

    function renderParams() {
      const container = document.getElementById('params-container');
      container.innerHTML = '';
      const util = utilInput.value;
      const params = PARAM_MAP[util] || [];
      params.forEach(p => {
        const div = document.createElement('div');
        const input = document.createElement('input');
        const label = document.createElement('label');
        label.textContent = p.label;
        input.name = p.name;
        if (p.type === 'boolean') {
          div.className = 'form-check mb-3';
          input.type = 'checkbox';
          input.className = 'form-check-input';
          input.value = '1';
          input.id = p.name;
          label.className = 'form-check-label';
          label.setAttribute('for', p.name);
          div.appendChild(input);
          div.appendChild(label);
        } else if (p.type === 'date') {
          div.className = 'mb-3';
          input.type = 'date';
          input.className = 'form-control';
          label.className = 'form-label';
          div.appendChild(label);
          div.appendChild(input);
        } else {
          div.className = 'mb-3';
          input.type = 'text';
          input.className = 'form-control';
          label.className = 'form-label';
          div.appendChild(label);
          div.appendChild(input);
        }
        container.appendChild(div);
      });
    }

      function updateMode() {
        const util = utilInput.value;
        const isUploadOnly = UPLOAD_ONLY_UTILS.includes(util);
        const inputGroup = document.getElementById('input-mode-group');
        if (isUploadOnly) {
          inputGroup.style.display = 'none';
          document.getElementById('mode-upload').checked = true;
        } else {
          inputGroup.style.display = '';
        }
        const mode = isUploadOnly ? 'file' : document.querySelector('input[name="input_mode"]:checked').value;
        document.getElementById('file-container').style.display = mode === 'file' ? '' : 'none';
        const paramsVisible = !(mode === 'file' && util !== 'call_openai_llm');
        document.getElementById('params-container').style.display = paramsVisible ? '' : 'none';
      }
    document.querySelectorAll('.util-card').forEach(card => {
        card.addEventListener('click', () => {
          selectUtil(card.dataset.util);
          renderParams();
        });
      });
    document.querySelectorAll('input[name="input_mode"]').forEach(el => el.addEventListener('change', updateMode));
    const form = document.getElementById('util-form');
    const spinner = document.getElementById('run-spinner');
    const runBtn = document.getElementById('run-button');
    const outputSection = document.getElementById('output-section');
    form.addEventListener('submit', () => {
      if (spinner) spinner.style.display = 'inline-block';
      if (runBtn) runBtn.disabled = true;
      if (outputSection) outputSection.innerHTML = '';
    });
    document.addEventListener('DOMContentLoaded', () => {
      selectUtil(utilInput.value);
      renderParams();
      updateMode();
    });
  </script>

{% endblock %}
